// üëâ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Supabase ‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û
const { supabase } = require('../utils/supabaseClient');
const { uploadBase64ImageToSupabase } = require('../utils/uploadSlipToSupabase');

// üëâ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å
const handleFullPurchase = async (req, res) => {
  try {
    // üü° STEP 1: ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
    const {  
      ref_code, first_name, last_name, address, postal_code, 
      phone_number, email, national_id, file_name, file_content 
    } = req.body;

    // üîç Logic 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!ref_code?.trim() || !first_name?.trim() || !last_name?.trim() || 
        !address?.trim() || !postal_code?.trim() || !phone_number?.trim()) {
      console.log("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö:", req.body);
      return res.status(400).json({ message: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö' });
    }
    console.log("‚úÖ Logic1 ‡∏ú‡πà‡∏≤‡∏ô: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß");

    // üîç ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå
    if (!file_content || !file_content.trim()) {
      console.log("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î");
      return res.status(400).json({ message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' });
    }

    // üîç Logic 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ ref_code ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô auth_sessions ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const { data: sessionData, error: sessionError } = await supabase
      .from('auth_sessions')
      .select('*')
      .eq('ref_code', ref_code)
      .single();

    if (sessionError || !sessionData) {
      console.log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö ref_code ‡πÉ‡∏ô auth_sessions:", ref_code, sessionError);
      return res.status(404).json({ message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Ref.Code' });
    }

    // üü¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡πÉ‡∏ô auth_sessions
    const { error: updateError } = await supabase
      .from('auth_sessions')
      .update({
        first_name,
        last_name,
        phone_number, 
        postal_code, 
        email,
        national_id      
      })
      .eq('ref_code', ref_code);

    if (updateError) {
      console.error("‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï auth_sessions ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", updateError);
      return res.status(500).json({ message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    }

    console.log("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï auth_sessions ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");

    // üü¢ Logic 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á license_no ‡πÉ‡∏´‡∏°‡πà
    const { data: allLicenses, error: licenseFetchError } = await supabase
      .from('license_holders')
      .select('license_no');

    if (licenseFetchError) {
      console.error('‚ùå ‡∏î‡∏∂‡∏á license_no ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:', licenseFetchError);
      return res.status(500).json({ message: '‡∏î‡∏∂‡∏á license_no ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    }

    const maxNum = allLicenses
      .map(row => parseInt(row.license_no.replace('ADT', ''), 10))
      .filter(num => !isNaN(num))
      .reduce((max, num) => Math.max(max, num), 0);

    const newLicenseNo = `ADT${(maxNum + 1).toString().padStart(3, '0')}`;
    console.log('‚úÖ license_no ‡πÉ‡∏´‡∏°‡πà:', newLicenseNo);

    // üü¢ Logic 4: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á license_holders
    const { error: insertLicenseError } = await supabase
      .from('license_holders')
      .insert([
        {
          license_no: newLicenseNo,
          ref_code,
          first_name,
          last_name,
          national_id,
          phone_number,
          email,
          address,
          postal_code,
          line_user_id: sessionData.line_user_id,
          pdpa_status: true,
          is_verify: true
        }
      ]);

    if (insertLicenseError) {
      console.error('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å license ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', insertLicenseError);
      return res.status(500).json({ message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å license ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    }

    console.log("‚úÖ Logic4 ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å license_holders ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");

    // ‚úÖ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° productSource
    let productSource = sessionData?.product_source;
    if (!productSource || typeof productSource !== 'string') {
      console.warn("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ product_source ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà string ‚Üí ‡πÉ‡∏ä‡πâ default");
      productSource = 'ADT-01-5500';
    }

    console.log("üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• slip_submissions:", {
      ref_code,
      first_name,
      last_name,
      national_id,
      phone_number,
      license_no: newLicenseNo,
      product_source: productSource
    });

    // ‚úÖ insert ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• slip (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô) - ‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ñ‡πâ‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô insert slip)
    const slipFileName = `ADT-01-${newLicenseNo}-SLP-${ref_code}.jpg`;
    console.log("üì∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ:", slipFileName);

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö base64 format
    let processedFileContent = file_content;
    if (!file_content.startsWith('data:image/')) {
      processedFileContent = `data:image/jpeg;base64,${file_content}`;
      console.log("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° data URL prefix ‡πÉ‡∏´‡πâ base64 string");
    }

    const uploadResult = await uploadBase64ImageToSupabase({
      base64String: processedFileContent,
      fileName: slipFileName,
      bucket: 'adtpayslip'
    });

    if (!uploadResult.success) {
      console.error("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", uploadResult.error);
      // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏•‡∏ö license_holder ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
      await supabase.from('license_holders').delete().eq('license_no', newLicenseNo);
      return res.status(500).json({ 
        message: '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 
        error: uploadResult.error 
      });
    }

    const slipImageUrl = uploadResult.publicUrl;
    console.log("‚úÖ ‡πÑ‡∏î‡πâ public URL:", slipImageUrl);

    // ‚úÖ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≠‡∏¢ insert slip_submissions
    const { data: insertedSlip, error: slipInsertError } = await supabase
      .from('slip_submissions')
      .insert([
        {
          ref_code,
          first_name,
          last_name,
          national_id,
          phone_number,
          license_no: newLicenseNo,
          product_source: productSource,
          slip_image_url: slipImageUrl,
          slip_path: slipFileName,
          submissions_status: 'pending'
        }
      ])
      .select();

    if (slipInsertError) {
      console.error("‚ùå Insert slip_submissions failed:", slipInsertError);
      // ‡∏ñ‡πâ‡∏≤ insert ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
      await supabase.storage.from('adtpayslip').remove([slipFileName]);
      await supabase.from('license_holders').delete().eq('license_no', newLicenseNo);
      return res.status(500).json({ message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• slip ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });
    }

    console.log("‚úÖ insert slip_submissions ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", insertedSlip[0]);

    // üéâ ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö
    return res.status(200).json({ 
      message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 
      license_no: newLicenseNo,
      slip_url: slipImageUrl
    });

  } catch (err) {
    console.error("‚ùå ERROR ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°:", err);
    return res.status(500).json({ 
      message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö',
      error: err.message 
    });
  }
};

module.exports = handleFullPurchase;
